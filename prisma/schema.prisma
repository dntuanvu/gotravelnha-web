// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String?
  firstName String?
  lastName  String?
  role      Role     @default(USER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // OAuth fields
  provider      String?  // google, auth0, etc
  providerId    String?  // OAuth provider's user ID
  providerImage String?  // Profile image from OAuth provider
  
  // Password reset fields
  resetToken        String?
  resetTokenExpires DateTime?
  
  // Relations
  bookings      Booking[]
  loyaltyPoints LoyaltyPoint[]
  referrals     Referral[]      @relation("Referrer")
  referredBy    Referral?       @relation("Referee")
  
  @@unique([provider, providerId], name: "provider_unique")
  @@map("users")
}

model Booking {
  id          String   @id @default(uuid())
  userId      String
  platform    String   // trip, klook, attractionsg
  bookingType String   // hotel, flight, activity
  bookingData Json?
  status      String   // pending, confirmed, cancelled
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("bookings")
}

model LoyaltyPoint {
  id          String   @id @default(uuid())
  userId      String
  points      Int
  reason      String?
  createdAt   DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("loyalty_points")
}

model Referral {
  id              String   @id @default(uuid())
  referrerId      String   // User who shared the referral
  refereeId       String?  @unique // User who signed up via referral (nullable until they sign up) - unique so one user can only use one referral
  referralCode    String   @unique // Unique code for sharing
  email           String?  // Email of person who clicked referral (before signup)
  status          ReferralStatus @default(PENDING) // PENDING, SIGNED_UP, COMPLETED_BOOKING, REWARDED
  rewardPoints    Int      @default(0) // Points given to referrer
  signupAt        DateTime?
  firstBookingAt  DateTime?
  rewardedAt      DateTime?
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  referrer User @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referee  User? @relation("Referee", fields: [refereeId], references: [id], onDelete: SetNull)
  
  @@index([referralCode])
  @@index([referrerId])
  @@index([status])
  @@map("referrals")
}

enum ReferralStatus {
  PENDING            // Link clicked but user not signed up yet
  SIGNED_UP          // User signed up via referral
  COMPLETED_BOOKING  // User made their first booking
  REWARDED           // Points rewarded to referrer
}

model NewsletterSubscriber {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String?
  source        String?  // homepage, deals, blog, etc
  isActive      Boolean  @default(true)
  subscribedAt  DateTime @default(now())
  unsubscribedAt DateTime?
  metadata      Json?
  
  @@map("newsletter_subscribers")
}

model BlogPost {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  excerpt     String?
  content     String   // Markdown or HTML
  authorId    String
  category    String?
  tags        String[]
  featuredImage String?
  isPublished Boolean  @default(false)
  publishedAt DateTime?
  views       Int      @default(0)
  seoMeta     Json?    // SEO metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([slug])
  @@index([category])
  @@index([isPublished])
  @@map("blog_posts")
}

model AttractionsgEvent {
  id                   String   @id
  title                String
  slug                 String?
  description          String?
  priceText            String?
  priceAmount          Float?
  originalPriceText    String?
  originalPriceAmount  Float?
  publicPrice          Float?
  image                String?
  category             String?
  location             String?
  rating               Float?
  link                 String? @unique
  duration             String?
  ageRestriction       String?
  cancellation         String?
  validFrom            String?
  validTo              String?
  lastSeenAt           DateTime @default(now())
  isActive             Boolean  @default(true)
  isPublished          Boolean  @default(false)
  publishedAt          DateTime?
  notes                String?
  isSelfBookable       Boolean  @default(false)
  stripePriceId        String?
  checkoutNotes        String?
  bookings             AttractionsgBooking[]
  raw                  Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("attractionsg_events")
  @@index([category])
  @@index([isActive])
  @@index([title])
}

model UserActivity {
  id             String   @id @default(cuid())
  sessionId      String
  timestamp      DateTime
  page           String
  action         String
  data           Json?
  userAgent      String?
  viewportWidth  Int?
  viewportHeight Int?
  createdAt      DateTime @default(now())

  @@map("user_activities")
  @@index([timestamp])
  @@index([page])
  @@index([action])
  @@index([sessionId])
}

model AttractionsgBooking {
  id                   String         @id @default(cuid())
  eventId              String
  eventTitle           String
  eventSlug            String?
  quantity             Int            @default(1)
  amount               Float
  currency             String         @default("SGD")
  status               BookingStatus  @default(PENDING)
  stripeSessionId      String         @unique
  stripePaymentIntentId String?
  customerEmail        String?
  customerName         String?
  customerPhone        String?
  optionCode           String?
  optionName           String?
  metadata             Json?
  notes                String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  event AttractionsgEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([status])
  @@map("attractionsg_bookings")
}

enum BookingStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
}

model PriceAlert {
  id            String   @id @default(uuid())
  userId        String
  platform      String   // trip, klook, attractionsg
  productType   String   // hotel, flight, activity
  productId     String   // ID or URL of the product
  productName   String
  currentPrice  Float?
  targetPrice   Float?   // Alert when price drops to this
  originalUrl   String
  isActive      Boolean  @default(true)
  triggeredAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
  @@index([platform, productType])
  @@index([isActive])
  @@map("price_alerts")
}

model ScraperJob {
  id          String         @id @default(uuid())
  platform    String         // trip, klook, attractionsg
  sourceUrl   String         // The URL being scraped
  jobType     String         // event, deal, promotion
  status      ScraperStatus  @default(PENDING)
  priority    Int            @default(0) // Higher = more priority
  startedAt   DateTime?
  completedAt DateTime?
  error       String?
  metadata    Json?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  // Relations
  source    ScraperSource    @relation(fields: [sourceUrl], references: [url], onDelete: Cascade)
  dataItems TripScrapedData[]
  
  @@map("scraper_jobs")
}

model ScraperSource {
  url           String        @id // Unique URL
  platform      String        // trip, klook, attractionsg
  sourceType    String        // affiliate_link, search_url, promotion_page
  isActive      Boolean       @default(true)
  lastScrapedAt DateTime?
  scrapeCount   Int           @default(0)
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Relations
  jobs ScraperJob[]
  
  @@map("scraper_sources")
}

model TripScrapedData {
  id                String      @id @default(uuid())
  jobId             String
  title             String
  description       String?
  originalPrice     Decimal?
  discountedPrice   Decimal?
  discount          String?
  currency          String?
  image             String?
  affiliateLink     String?
  location          String?
  dates             String?
  category          String?
  metadata          Json?
  isValid           Boolean     @default(true)
  duplicateOf       String?     // ID of duplicate if this is a duplicate
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  job ScraperJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  @@index([jobId])
  @@index([category])
  @@index([isValid])
  @@map("trip_scraped_data")
}

model KlookPromoCode {
  id                        String   @id @default(uuid())
  promoCode                 String   @unique // e.g., DLTCAL8
  discountDescription       String   // e.g., 8% off
  promoCodeDescription      String   // Full description
  affiliateDescription      String   // Affiliate version
  applicablePlatforms       String   // All platforms, App only, etc
  redeemFrom                DateTime
  redeemBefore              DateTime
  validUntil                DateTime
  timeZone                  String
  termsAndConditions        String   @db.Text
  applicableToResidentsOf   String?  // Country codes separated by ;
  notApplicableToResidentsOf String? // Country codes
  nonApplicableActivitiesUrl String? // URL
  
  // Status tracking
  isActive                  Boolean  @default(true)
  importedAt                DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  
  @@index([promoCode])
  @@index([isActive])
  @@index([validUntil])
  @@map("klook_promo_codes")
}

model KlookHotelDeal {
  id                String   @id @default(uuid())
  hotelId           String   @unique // Master hotel ID from Klook
  hotelName         String
  dealCategory      String   // Big sale, Bestseller, etc
  starRating        Int?
  
  // Pricing
  originalPrice     Decimal  // Sell price
  discountedPrice   Decimal  // Deal price
  currency          String   @default("USD")
  savings           Decimal
  savingsPercent    Decimal? // Auto-calculated
  
  // Links
  affiliateLink     String
  
  // Metadata
  importedAt        DateTime @default(now())
  updatedAt         DateTime @updatedAt
  isActive          Boolean  @default(true)
  
  @@index([hotelId])
  @@index([dealCategory])
  @@index([isActive])
  @@index([updatedAt])
  @@map("klook_hotel_deals")
}

model KlookWidget {
  id            String   @id @default(uuid())
  adId          String   // Ad ID from Klook portal (one per category)
  name          String
  description   String
  icon          String
  category      String?
  widgetType    String   @default("things_to_do") // things_to_do or hotels
  isActive      Boolean  @default(true)
  displayOrder  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([name])
  @@index([isActive])
  @@index([displayOrder])
  @@index([widgetType])
  @@map("klook_widgets")
}

model DataComparison {
  id             String   @id @default(uuid())
  title          String
  platform1      String   // trip
  platform2      String   // klook, attractionsg, etc
  price1         Decimal
  price2         Decimal
  currency       String
  savingsPercent Decimal?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([title])
  @@map("data_comparisons")
}

enum Role {
  ADMIN
  USER
}

enum ScraperStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}
